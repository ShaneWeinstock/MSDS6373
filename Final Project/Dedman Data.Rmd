---
title: "Using Turnstile Data To Forcast Student Worker Staffing"
author: "Chad Madding, Shane Weinstock"
date: "March 12, 2020"
output: html_document
---

**Deliverables:**  

**EDA:**  

Saturday March 21 at 11:59pm  

**Deliverable:**  

1.	3-minute YouTube video: (You can use the same slides but each team member must make the full presentation with all the slides.)  

    a.	Identify yourself and your team (if applicable).  
    b.	Describe Data Set / Time Series (Who, What, When, Where, Why and How)  
    c.	Stationary / Non-Stationary  
    d.	ACFs and Spectral Densities just to explore  
    e.	At least 2 candidate ARMA / ARIMA models  
    
        a.	The models in factored form or at least separate the stationary and non-stationary factors with standard deviation or variance of the white noise.  
        b.	AIC  
        c.	ASE  
        d.	Visualization of Forecasts with a Practical Horizon.  
        j.	Strategy / Plans for the rest of the analysis.  
    
2.	Submit your slides to 2DS and make sure your video URL is on the Google Doc. 



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tswge)
library(plyr)
library(dplyr)
library(forecast)
library(ggplot2)
library(ggthemes)
```

### Describe Data Set  
####Time Series (Who, What, When, Where, Why and How)

This is a time series data set collected from three turnstiles at the Dedman Center for Lifetime Sports on the Southern Methodist University campus. The data set is a record of the time of swipe, the turnstile used and an anonymized student ID number. This was collected from January 2nd, 2019 through March 11th, 2020 and consists of 414156 entries. Entry and error swipes are included in the data. It should be noted that the turnstiles are only used to enter the facility and ID swipe is not required to exit the building.  

**Read in the data**  
```{r Read in}
#Read in the data
SMUSwipe <- read_excel("AnonDataTurnstile.xlsx")
```

**Data Cleaning**  

Compactly Display the Structure of the data.
```{r Cleaning, echo=FALSE}
#Data Cleaning
str(SMUSwipe)
#Remove any rejected \ change state rows
SMUSwipe = SMUSwipe[SMUSwipe[,2]=="CardAdmitted",]
#Create a Time column
SMUSwipe$Time <- format(SMUSwipe$LDT,"%H:%M:%S")
#Create a Day column
SMUSwipe$Day <- format(SMUSwipe$LDT,"%d")
#Create a Date column
SMUSwipe$Date <- as.Date(SMUSwipe$LDT)
#Create an Hour column
SMUSwipe$Hour <- format(SMUSwipe$LDT,"%H")
#Create a Day coloum
SMUSwipe$Day <- weekdays(as.Date(SMUSwipe$LDT))
#Create an Hours coloum for count
SMUSwipe$Hours <- format(SMUSwipe$LDT,"%Y-%m-%d-%H")
head(SMUSwipe)
```

Hourly ID Swipes for all Turnstiles?
```{r Hour Group}
#Group all badge swipes by the hour
df = count(SMUSwipe, Hours)
hourplot = count(SMUSwipe,Hour)

hourplot %>%
  ggplot(aes(x=Hour,y=n, group=1))+
  geom_line()+
  geom_point()+
  theme_economist()+
  scale_colour_economist()+
  ggtitle('Hourly ID Swipes for all Turnstiles')
```

What are the Daily ID Swipes for all Turnstiles?  
```{r}
dayCount=count(SMUSwipe, Day)
dayCount$Day <- factor(dayCount$Day, levels= c("Sunday", "Monday", 
    "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"))

dayCount=dayCount[order(dayCount$Day), ]
  
dayCount %>%
  ggplot(aes(x=Day,y=n, group=1))+
  geom_line()+
  geom_point()+
  theme_economist()+
  scale_colour_economist()+
  theme_economist()+
  ggtitle('Daily ID Swipes for all Turnstiles')+
  ylab('ID Swipes')
```

We want to group all ID swipes by 15 minutes (quarter hour).
```{r 15 Minute Group}
#Group all ID swipes by 15 minutes (quarter hour)
SMUSwipe$Minutes <- format(SMUSwipe$LDT,"%M")
SMUSwipe$interval_15 <-ifelse(SMUSwipe$Minutes <= 15, 1, ifelse(SMUSwipe$Minutes <= 30, 2, ifelse(SMUSwipe$Minutes <= 45, 3, ifelse(SMUSwipe$Minutes <= 60, 4))))
SMUSwipe$Minutes_15<-paste(SMUSwipe$Hours, SMUSwipe$interval_15, sep=" ")
```

Create a data set for each turnstile.  
```{r}
#Create a dataset for each turnstyle
SMUSwipeTurn1 = SMUSwipe[SMUSwipe[,4]=="DEDM (101.1LB)",]
SMUSwipeTurn2 = SMUSwipe[SMUSwipe[,4]=="DEDM (101.2LB)",]
SMUSwipeTurn3 = SMUSwipe[SMUSwipe[,4]=="DEDM (101.3LB)",]

HTurn1 = count(SMUSwipeTurn1, Hour)
HTurn1 %>%
  ggplot(aes(x=Hour,y=n, group=1))+
  geom_line()+
  geom_point()+
  theme_economist()+
  scale_colour_economist()+
  ggtitle('Hourly Card Swipes for Turnstile 1')

HTurn2 = count(SMUSwipeTurn2, Hour)
HTurn2 %>%
  ggplot(aes(x=Hour,y=n, group=1))+
  geom_line()+
  geom_point()+
  theme_economist()+
  scale_colour_economist()+
  ggtitle('Hourly Card Swipes for Turnstile 2')

HTurn3 = count(SMUSwipeTurn3, Hour)
HTurn3 %>%
  ggplot(aes(x=Hour,y=n, group=1))+
  geom_line()+
  geom_point()+
  theme_economist()+
  scale_colour_economist()+
  ggtitle('Hourly Card Swipes for Turnstile 3')

#15 minute counts
df15 = count(SMUSwipe, Minutes_15)
df15Turn1 = count(SMUSwipeTurn1, Minutes_15)
df15Turn2 = count(SMUSwipeTurn2, Minutes_15)
df15Turn3 = count(SMUSwipeTurn3, Minutes_15)
```
Looks like turnstile 3 gets used more than the others but the pattern of usage looks the same accross each.  

This data is anamonized but we can still see who are some of the top users.
```{r ID Count}
#This will count up the times users swiped in. 
IDCount = count(SMUSwipe, `ID#`)
#Print off the top 10 users ordering nuency in decending order
head(IDCount[order(IDCount$n, decreasing = TRUE),],10)
```
Look at some user data.
```{r}
#Breakdown user numbers
summary(IDCount$n)
#how many uses
count(IDCount)
```

Convert the hourly and 15 minute data to time series.
```{r}
#Hourley data
AnonDataTurnstile = ts(df$n)
#15 min-break data
AnonDataTurnstile_15 = ts(df15$n)
AnonDataTurnstile1_15 = ts(df15Turn1$n)
AnonDataTurnstile2_15 = ts(df15Turn2$n)
AnonDataTurnstile3_15 = ts(df15Turn3$n)
```

####Visualize what we have so far.

**Plot the hourly data for all three turnstyles**
```{r Visualize turn hour, echo=T, results='hide'}
#Plot the hourly data
TurnPlotHour=plotts.sample.wge(AnonDataTurnstile)
```
####Plot the 15 minute data

**15 minute data for all three turnstiles**
```{r Visualize turn all 3, echo=T, results='hide'}
#Plot the 15 minute data
TurnPlotAll15=plotts.sample.wge(AnonDataTurnstile_15)
```

**15 minute data for turnstile one**
```{r Visualize turn one 15, echo=T, results='hide'}
#Plot the 15 minute data
TurnPlot1=plotts.sample.wge(AnonDataTurnstile1_15)
```

**15 minute data for turnstile two**
```{r Visualize turn 2 15, echo=T, results='hide'}
#Plot the 15 minute data
TurnPlot2=plotts.sample.wge(AnonDataTurnstile2_15)
```

**15 minute data for turnstile three**
```{r Visualize turn 3 15, echo=T, results='hide'}
#Plot the 15 minute data
TurnPlot3=plotts.sample.wge(AnonDataTurnstile3_15)
```

Start ID'ing the data by using the Box and Jeakins method with first differcing the data
```{r Differcing the data, echo=T, results='hide'}
#Differcing the data to use the Box and Jeakins method
AnonDataTurnstile_diff=artrans.wge(AnonDataTurnstile,phi.tr=1)
AnonDataTurnstile_15_diff=artrans.wge(AnonDataTurnstile_15,phi.tr=1)
Turnstile1_15_diff=artrans.wge(AnonDataTurnstile1_15,phi.tr=1)
Turnstile2_15_diff=artrans.wge(AnonDataTurnstile2_15,phi.tr=1)
Turnstile3_15_diff=artrans.wge(AnonDataTurnstile3_15,phi.tr=1)
```

```{r, echo=T, results='hide'}
#Plot the differeaced hourly data - diff
plotts.sample.wge(AnonDataTurnstile_diff)
```


Get a few more plots of the differenced data
```{r, echo=T, results='hide'}
#Plot the 15 minute data - diff
plotts.sample.wge(AnonDataTurnstile_15_diff)
```

Use aic5.wge() to identify estimates of p and q on the differanced 15 minute data.
```{r aic5}
#AIC of the hourly data
aic5.wge(AnonDataTurnstile_diff)
#aic5.wge(AnonDataTurnstile_15_diff)
#aic5.wge(Turnstile1_15_diff)
#aic5.wge(Turnstile2_15_diff)
#aic5.wge(Turnstile3_15_diff)
#Changing some settings
#aic5.wge(AnonDataTurnstile_15_diff,p=0:11,q=0:5,type="aic")
#aic5.wge(AnonDataTurnstile_15_diff,p=0:11,q=0:5,type="bic")
```

Use the estimate of p and q to get estimates of the phis and thetas.
```{r estimate}
#Use the estimate of p and q to get estimates of the phis and thetas.
est = est.arma.wge(AnonDataTurnstile_diff, p = 4, q = 1)
```

```{r}
#Use the estimated model to forecast and so on. 
phi=est$phi
phi
theta=est$theta
theta
wnv=est$avar
wnv
```

#### Final Model
$$(1-B)(1-0.626B-0.119B^2-0.006B^3+0.195B^4)X_t=(1-0.973B)a_t\  \sigma^2_a=872.23$$

```{r}
#forcasting
fore15_diff=fore.arma.wge(AnonDataTurnstile_15_diff, phi = est$phi, theta = est$theta, lastn = T, n.ahead = 48, limits=F)
#forcast hour
foreHour_diff=fore.arma.wge(AnonDataTurnstile_diff, phi = est$phi, theta = est$theta, lastn = T, n.ahead = 48, limits=F)
```

Lets see what a Seasonal Model might look like
```{r Factor}
#Factor tables
fact15_diff=est.ar.wge(AnonDataTurnstile_15,p=8,type='burg')
```

Trying the forecasting package on the hourly data
```{r forcasting package hourly data}
#Trying the forcasting package on the 15 minute data
AnonDataTurnstile.f = auto.arima(AnonDataTurnstile, stepwise=FALSE, approximation=FALSE)

AnonDataTurnstile.f

HourForcast=forecast(AnonDataTurnstile.f, h=48, level = 95)
HourForcast
# Automatic ARIMA forecasts
AnonDataTurnstile %>%
  auto.arima() %>%
  forecast(h=48) %>%
  autoplot()
```

Trying the forecasting package on the 15 minute data
```{r forcasting package 15 minute data}
#Trying the forcasting package on the 15 minute data
AnonDataTurnstile_15.f = auto.arima(AnonDataTurnstile_15, stepwise=FALSE, approximation=FALSE)

forecast(AnonDataTurnstile_15)

# Automatic ARIMA forecasts
AnonDataTurnstile_15 %>%
  auto.arima() %>%
  forecast(h=600) %>%
  autoplot()
```

