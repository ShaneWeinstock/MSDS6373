---
title: "Using Turnstile Data To Forcast Student Worker Staffing"
author: "Chad Madding, Shane Weinstock"
date: "March 12, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tswge)
library(plyr)
library(forecast)
library(ggplot2)
```

## Read in the data

The data is from three turnstiles at the Dedman Center for Lifetime Sports on the Southern Methodist University campus. 
```{r Read in}
#Read in the data
SMUSwipe <- read_excel("AnonDataTurnstile.xlsx")
```

## Data Cleaning

Compactly Display the Structure of the data.
```{r Cleaning, echo=FALSE}
#Data Cleaning
str(SMUSwipe)
#Remove any rejected \ change state rows
SMUSwipe = SMUSwipe[SMUSwipe[,2]=="CardAdmitted",]
#Create a Time column
SMUSwipe$Time <- format(SMUSwipe$LDT,"%H:%M:%S")
#Create a Date column
SMUSwipe$Date <- as.Date(SMUSwipe$LDT)
```

Grouping up the data.
```{r}
#Let's group all badge swipes by the hour
SMUSwipe$Hours <- format(SMUSwipe$LDT,"%Y-%m-%d-%H")
head(SMUSwipe)
df = count(SMUSwipe, "Hours")



#Let's group all badge swipes by 15 minutes (quarter hour)
SMUSwipe$Minutes <- format(SMUSwipe$LDT,"%M")
SMUSwipe$interval_15 <-ifelse(SMUSwipe$Minutes <= 15, 1, ifelse(SMUSwipe$Minutes <= 30, 2, ifelse(SMUSwipe$Minutes <= 45, 3, ifelse(SMUSwipe$Minutes <= 60, 4))))
SMUSwipe$Minutes_15<-paste(SMUSwipe$Hours, SMUSwipe$interval_15, sep=" ")

#Create a dataset for each turnstyle
SMUSwipeTurn1 = SMUSwipe[SMUSwipe[,4]=="DEDM (101.1LB)",]
SMUSwipeTurn2 = SMUSwipe[SMUSwipe[,4]=="DEDM (101.2LB)",]
SMUSwipeTurn3 = SMUSwipe[SMUSwipe[,4]=="DEDM (101.3LB)",]

df15 = count(SMUSwipe, "Minutes_15")
df15Turn1 = count(SMUSwipeTurn1, "Minutes_15")
df15Turn2 = count(SMUSwipeTurn2, "Minutes_15")
df15Turn3 = count(SMUSwipeTurn3, "Minutes_15")
```

Convert the hourly and 15 minute data to time series
```{r}
#Hourley data
AnonDataTurnstile = ts(df$freq)
#15 min-break data
AnonDataTurnstile_15 = ts(df15$freq)
AnonDataTurnstile1_15 = ts(df15Turn1$freq)
AnonDataTurnstile2_15 = ts(df15Turn2$freq)
AnonDataTurnstile3_15 = ts(df15Turn3$freq)
```

Visualize what we have so far.
```{r Visualize turn, echo=T, results='hide'}
#Plot the hourly data
TurnPlotHour=plotts.sample.wge(AnonDataTurnstile)
#Plot the 15 minute data
TurnPlotAll15=plotts.sample.wge(AnonDataTurnstile_15)
TurnPlot1=plotts.sample.wge(AnonDataTurnstile1_15)
TurnPlot2=plotts.sample.wge(AnonDataTurnstile2_15)
TurnPlot3=plotts.sample.wge(AnonDataTurnstile3_15)
```

Start ID'ing the data by using the Box and Jeakins method with first differcing the data
```{r, echo=T, results='hide'}
#Differcing the data to use the Box and Jeakins method
AnonDataTurnstile_15_diff=artrans.wge(AnonDataTurnstile_15,phi.tr=1)
Turnstile1_15_diff=artrans.wge(AnonDataTurnstile1_15,phi.tr=1)
Turnstile2_15_diff=artrans.wge(AnonDataTurnstile2_15,phi.tr=1)
Turnstile3_15_diff=artrans.wge(AnonDataTurnstile3_15,phi.tr=1)
```


Get a few more plots of the differenced data
```{r, echo=T, results='hide'}
#Plot the 15 minute data - diff
plotts.sample.wge(AnonDataTurnstile_15_diff)
```

Use aic5.wge() to identify estimates of p and q.
```{r aic5}
aic5.wge(AnonDataTurnstile_15_diff)
aic5.wge(Turnstile1_15_diff)
aic5.wge(Turnstile2_15_diff)
aic5.wge(Turnstile3_15_diff)
#Changing some settings
#aic5.wge(AnonDataTurnstile_15_diff,p=0:11,q=0:5,type="aic")
#aic5.wge(AnonDataTurnstile_15_diff,p=0:11,q=0:5,type="bic")
```

Use the estimate of p and q to get estimates of the phis and thetas.
```{r estimate}
#Use the estimate of p and q to get estimates of the phis and thetas.
est = est.arma.wge(AnonDataTurnstile_15_diff, p = 5, q = 2)
```

```{r}
#Use the estimated model to forecast and so on. 
phi=est$phi
phi
theta=est$theta
theta
wnv=est$avar
wnv
```

#### Final Model
$$(1-B)(1-0.286B+0.911B^2+0.367B^3+0.196B^4+0.415B^5)X_t=(1-0.871B+0.710B^2)a_t\  \sigma^2_a=133.33$$

```{r}
#forcasting
fore15_diff=fore.arma.wge(AnonDataTurnstile_15_diff, phi = est$phi, theta = est$theta, lastn = T, n.ahead = 25, limits=F)
```

Lets see what a Seasonal Model might look like
```{r Factor}
#Factor tables
fact15_diff=est.ar.wge(AnonDataTurnstile_15,p=8,type='burg')
```

Trying the forecasting package on the 15 minute data
```{r forcasting package}
#Trying the forcasting package on the 15 minute data
auto.arima(AnonDataTurnstile_15, stepwise=FALSE, approximation=FALSE)

forecast(AnonDataTurnstile_15)

# Automatic ARIMA forecasts
AnonDataTurnstile_15 %>%
  auto.arima() %>%
  forecast(h=20) %>%
  autoplot()
```

